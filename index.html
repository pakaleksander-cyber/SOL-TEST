<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Debt Collection Portfolio IRR Model</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
/* (CSS оставлен без изменений для компактности ответа) */
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f172a;color:#f1f5f9;margin:0}
.container{display:flex;min-height:100vh}
.sidebar{width:400px;background:#1e293b;padding:24px;overflow:auto}
.main-content{flex:1;padding:24px;overflow:auto}
input,button{padding:8px;border-radius:6px;border:none}
button{cursor:pointer}
.chart-container{background:#1e293b;padding:20px;border-radius:8px;margin-bottom:24px}
</style>
</head>
<body>

<div class="container">

<div class="sidebar">
<h1>IRR Calculator</h1>
<p>Коллекторский портфель • 36 месяцев</p>

<label>Number of Cases</label>
<input id="cases0" value="100000">

<label>Average Debt</label>
<input id="avgDebt" value="100000">

<label>Purchase Price %</label>
<input id="purchasePricePct" value="5">

<label>Total Recovery % (от PP)</label>
<input id="recoveryRatePct" value="300">

<label>Writeoff %</label>
<input id="writeoffRatePct" value="20">

<button onclick="calculateModel()">Рассчитать</button>
</div>

<div class="main-content">

<div id="kpiSection"></div>

<div class="chart-container">
<h3>Cumulative Recovery Curve (%)</h3>
<div id="recoveryCurveChart"></div>
</div>

<div id="dataTable"></div>

</div>
</div>

<script>

const defaultCurve = [
12.89,10.35,8.68,7.25,6.21,5.18,
4.66,4.14,3.62,3.62,3.11,3.11,
2.85,2.85,2.59,2.59,2.33,2.33,
2.07,2.07,2.07,1.81,1.81,1.81,
0,0,0,0,0,0,0,0,0,0,0,0
];

function calculateIRR(cashFlows, guess=0.1){
function npv(r){return cashFlows.reduce((s,cf,t)=>s+cf/Math.pow(1+r,t),0)}
let rate=guess
for(let i=0;i<1000;i++){
let f=npv(rate)
if(Math.abs(f)<1e-6)return rate
let df=(npv(rate+1e-6)-f)/1e-6
rate=rate-f/df
}
return null
}

function calculateModel(){

const N0=parseFloat(cases0.value)
const avgDebt=parseFloat(avgDebt.value)
const ppPct=parseFloat(purchasePricePct.value)
const recPct=parseFloat(recoveryRatePct.value)
const writeoffPct=parseFloat(writeoffRatePct.value)

const FV=N0*avgDebt
const PP=FV*(ppPct/100)
const TotalCollections=PP*(recPct/100)

let results=[]
results.push({month:0,net:-PP,cum:-PP,collections:0})

let cumulativeCollections=0
let casesInWork=N0

for(let t=1;t<=36;t++){

let recShare=defaultCurve[t-1]/100
let collections=TotalCollections*recShare
cumulativeCollections+=collections

let closed=collections/(TotalCollections/(N0*(1-writeoffPct/100)))
let writeoff=N0*(writeoffPct/100)/36

casesInWork=Math.max(0,casesInWork-closed-writeoff)

let net=collections
let prev=results[t-1]
let cum=prev.cum+net

results.push({month:t,net,cum,collections,casesInWork})
}

let irr=calculateIRR(results.map(r=>r.net))
let irrAnnual=irr?Math.pow(1+irr,12)-1:null

kpiSection.innerHTML=
"<h2>IRR месячный: "+(irr?(irr*100).toFixed(2)+"%":"N/A")+
"<br>IRR годовой: "+(irrAnnual?(irrAnnual*100).toFixed(2)+"%":"N/A")+"</h2>"

Plotly.newPlot('recoveryCurveChart',[{
x:results.slice(1).map(r=>r.month),
y:results.slice(1).map((r,i)=>defaultCurve.slice(0,i+1).reduce((a,b)=>a+b,0)),
type:'scatter'
}])

let html="<table border=1><tr><th>M</th><th>Collections</th><th>Cases</th></tr>"
results.forEach(r=>{
html+="<tr><td>"+r.month+"</td><td>"+Math.round(r.collections||0)+"</td><td>"+Math.round(r.casesInWork||0)+"</td></tr>"
})
html+="</table>"
dataTable.innerHTML=html
}

calculateModel()

</script>

</body>
</html>
